/**********************************************************************************************
*              Shanghai H&D EV Battery Co.,Ltd.
*             No.805 Chungui Road, Huangdu Town,
*             Jiading District, Shanghai 201804
*                         P.R. China
*
*             (c) Copyright 2011, H&D, ShangHai    
*                    All Rights Reserved
*
*File Name :     ADC.c
*Programmer(s) : Zeng Qunxin
*Descriprion :   适用于MC9S12G128单片机平台
*History :
*    <version>             <desc>                <time>       <author>
* 1.   V1.0          Build this moudle          2011-12-14   Zeng Qunxin
**********************************************************************************************/
#include "INCLUDES.h"
/************************************const value define***************************************/
/* NTC采样线的阻值--温度表 */
#ifdef CWF4103F3950F5L600
const INT16U ResTemp[RESTEMP_SIZE] = 
{ 
    26428,                                                           /*   -40     */
    25731,25034,24374,23713,23087,22460,21867,21273,20711,20149,
    19616,19084,18579,18075,17598,17120,16668,16216,15789,15361,     /* -39.5~-30 */
    14956,14552,14169,13786,13424,13061,12719,12376,12052,11728,
    11421,11115,10825,10535,10261, 9987, 9727, 9468, 9223, 8978,     /* -29.5~-20 */                                                  
     8746, 8514, 8294, 8075, 7868, 7660, 7464, 7268, 7082, 6896,
     6721, 6545, 6379, 6213, 6056, 5899, 5750, 5601, 5461,5320,      /* -19.5~-10 */
     5187, 5053, 4927, 4801, 4682, 4563, 4450, 4337, 4230,4123, 
     4022, 3920, 3824, 3729, 3638, 3547, 3461, 3375, 3293,3212,      /*  -9.5~0   */
     3134, 3057, 2984, 2911, 2841, 2772, 2706, 2640, 2577,2515,
     2456, 2397, 2340, 2284, 2231, 2178, 2127, 2076, 2027,1978,      /*   0.5~10  */
     1934, 1889, 1846, 1803, 1762, 1720, 1681, 1642, 1605,1568,
     1533, 1498, 1464, 1431, 1399, 1367, 1337, 1306, 1278,1249,      /*  10.5~20  */ 
     1221, 1194, 1168, 1142, 1117, 1092, 1069, 1045, 1022,1000,
      979,  957,  937,  916,  897,  878,  859,  841,  823, 805,      /*  20.5~30  */
      788,  772,  756,  740,  724,  709,  694,  680,  666, 652,
      639,  626,  613,  600,  588,  576,  564,  553,  542, 531,      /*  30.5~40  */
      520,  510,  500,  490,  480,  470,  461,  452,  443, 435,
      426,  418,  410,  402,  394,  386,  379,  372,  365, 359,      /*  40.5~50  */
      351,  344,  338,  331,  325,  319,  313,  307,  301, 296,      
      290,  285,  280,  274,  269,  264,  260,  255,  250, 246,      /*  50.5~60  */
      241,  237,  233,  228,  224,  220,  217,  213,  209, 205,
      202,  198,  195,  191,  188,  185,  181,  178,  175, 172,      /*  60.5~70  */
      169,  166,  163,  161,  158,  155,  153,  150,  148, 145,      
      143,  140,  138,  136,  133,  131,  129,  127,  125, 123,      /*  70.5~80  */                 
      121,  119,  117,  115,  113,  111,  110,  108,  106, 104       /*  80.5~85  */
                                                                  
};
#endif
#ifdef EF1I103KT10T02009G011
const INT16U ResTemp[RESTEMP_SIZE] = 
{ 
    22190,                                                           /*   -40     */
    21550,20910,20310,19710,19150,18590,18065,17540,17050,16560,
    16100,15640,15210,14780,14380,13980,13600,13220,12865,12510,     /* -39.5~-30 */
    12175,11840,11520,11200,10905,10610,10330,10050, 9790, 9530, 
     9284, 9037, 8805, 8573, 8355, 8137, 7931, 7725, 7532, 7338,     /* -29.5~-20 */
     7155, 6971, 6799, 6626, 6463, 6299, 6146, 5992, 5847, 5701,                                                       
     5564, 5427, 5298, 5168, 5046, 4923, 4807, 4691, 4582, 4472,     /* -19.5~-10 */
     4368, 4263, 4165, 4066, 3972, 3878, 3790, 3701, 3617, 3533,     
     3454, 3374, 3299, 3223, 3152, 3080, 3013, 2945, 2881, 2816,     /*  -9.5~0   */
     2754, 2692, 2634, 2575, 2520, 2464, 2411, 2358, 2308, 2258,     
     2210, 2162, 2117, 2072, 2029, 1985, 1944, 1903, 1864, 1825,     /*   0.5~10  */
     1788, 1750, 1714, 1678, 1644, 1610, 1578, 1545, 1514, 1483,     
     1454, 1424, 1396, 1368, 1341, 1314, 1289, 1263, 1239, 1214,     /*  10.5~20  */
     1191, 1168, 1146, 1123, 1102, 1080, 1060, 1039, 1020, 1000,      
      981,  963,  945,  927,  910,  892,  876,  860,  844,  828,     /*  20.5~30  */
      813,  798,  784,  769,  756,  742,  729,  715,  703,  690,     
      678,  666,  654,  642,  631,  620,  609,  599,  588,  578,     /*  30.5~40  */
      568,  558,  549,  539,  530,  521,  512,  504,  495,  487,     
      479,  471,  463,  455,  448,  440,  433,  426,  419,  412,     /*  40.5~50  */
      405,  399,  392,  386,  380,  374,  368,  362,  356,  351,     
      345,  340,  334,  329,  324,  319,  314,  309,  304,  300,     /*  50.5~60  */
      295,  290,  286,  282,  277,  273,  269,  265,  261,  257,     
      253,  249,  246,  242,  238,  235,  231,  228,  225,  221,     /*  60.5~70  */
      218,  215,  212,  209,  206,  203,  200,  197,  194,  192,     
      189,  186,  184,  181,  179,  176,  174,  171,  169,  167,     /*  70.5~80  */ 
      164,  162,  160,  158,  155,  153,  151,  149,  147,  145      /*  80.5~85  */                     
                                                                  
};
#endif
#ifdef TS103F3950ANL600
const INT16U ResTemp[RESTEMP_SIZE] = 
{ 
    29686,                                                           /*   -40     */
    28808,27929,27103,26277,25502,24726,23998,23270,22614,21958,     
    21311,20664,20059,19453,18887,18321,17791,17261,16765,16268,     /* -39.5~-30 */
    15809,15349,14918,14486,14081,13677,13296,12916,12559,12202,     
    11869,11536,11222,10909,10614,10319,10041, 9764, 9502, 9241,     /* -29.5~-20 */  
     9009, 8778, 8558, 8338, 8130, 7922, 7724, 7527, 7340, 7152,                                                    
     6959, 6765, 6583, 6401, 6229, 6058, 5897, 5737, 5585, 5434,     /* -19.5~-10 */
     5293, 5153, 5020, 4888, 4763, 4639, 4520, 4402, 4291, 4179,     
     4075, 3970, 3871, 3772, 3679, 3585, 3497, 3409, 3325, 3242,     /*  -9.5~0   */   
     3162, 3083, 3008, 2933, 2861, 2790, 2723, 2656, 2592, 2529,     
     2469, 2409, 2352, 2296, 2242, 2188, 2137, 2086, 2038, 1990,     /*   0.5~10  */ 
     1942, 1895, 1851, 1806, 1764, 1722, 1682, 1642, 1605, 1567,     
     1531, 1496, 1463, 1429, 1397, 1365, 1335, 1305, 1276, 1247,     /*  10.5~20  */
     1220, 1193, 1167, 1141, 1116, 1092, 1068, 1045, 1022, 1000,      
      979,  958,  937,  917,  898,  879,  860,  842,  825,  807,     /*  20.5~30  */
      791,  774,  758,  742,  727,  711,  697,  682,  668,  654,     
      641,  628,  615,  602,  590,  578,  567,  555,  544,  533,     /*  30.5~40  */
      522,  512,  501,  491,  482,  472,  463,  453,  445,  436,     
      427,  419,  411,  403,  395,  388,  380,  373,  366,  359,     /*  40.5~50  */
      352,  345,  339,  333,  326,  320,  314,  308,  303,  297,     
      292,  286,  281,  275,  270,  265,  260,  255,  250,  246,     /*  50.5~60  */
      241,  237,  233,  229,  225,  222,  218,  214,  211,  207,   
      204,  200,  197,  193,  190,  187,  183,  180,  177,  174,     /*  60.5~70  */
      171,  168,  166,  163,  160,  157,  155,  152,  150,  147,       
      145,  142,  139,  136,  134,  133,  131,  129,  127,  125,     /*  70.5~80  */ 
      123,  121,  119,  117,  115,  113,  111,  110,  108,  106      /*  80.5~85  */                     
                                                                  
};
#endif
#ifdef TEMP_130C049
const INT16U ResTemp[RESTEMP_SIZE] = 
{ 
    18850,                                                           /*   -40     */ //-50的10位AD 1020.9017
    18350,17850,17375,16900,16460,16020,15605,15190,14800,14410,     
    14040,13670,13325,12980,12655,12330,12020,11710,11420,11130,     /* -39.5~-30 */
    10850,10570,10310,10050, 9801, 9552, 9318, 9084, 8864, 8643,     
     8435, 8226, 8030, 7833, 7647, 7461, 7286, 7110, 6944, 6777,     /* -29.5~-20 */  
     6617, 6457, 6306, 6154, 6011, 5868, 5733, 5597, 5469, 5341,                                                    
     5220, 5098, 4983, 4868, 4759, 4650, 4547, 4443, 4345, 4247,     /* -19.5~-10 */
     4152, 4057, 3967, 3877, 3792, 3706, 3625, 3544, 3467, 3390,     
     3317, 3244, 3175, 3105, 3039, 2973, 2911, 2848, 2788, 2728,     /*  -9.5~0   */   
     2671, 2613, 2558, 2503, 2451, 2399, 2350, 2300, 2253, 2205,     
     2160, 2115, 2073, 2030, 1989, 1948, 1909, 1870, 1833, 1796,     /*   0.5~10  */ 
     1760, 1724, 1690, 1656, 1623, 1590, 1559, 1528, 1499, 1469,     
     1441, 1412, 1385, 1358, 1332, 1306, 1281, 1256, 1233, 1209,     /*  10.5~20  */
     1186, 1163, 1142, 1120, 1099, 1078, 1058, 1038, 1019, 1000,      
      982,  963,  946,  928,  911,  894,  878,  862,  847,  831,     /*  20.5~30  */
      816,  801,  787,  773,  759,  745,  732,  719,  707,  694,     
      682,  670,  658,  647,  636,  625,  614,  603,  593,  583,     /*  30.5~40  */
      573,  563,  553,  544,  535,  526,  517,  508,  500,  491,     
      483,  475,  467,  459,  452,  444,  437,  430,  423,  416,     /*  40.5~50  */
      409,  403,  396,  390,  383,  377,  371,  365,  359,  354,     
      348,  343,  337,  332,  327,  322,  317,  312,  307,  302,     /*  50.5~60  */
      297,  293,  288,  284,  279,  275,  271,  267,  263,  259,   
      255,  251,  247,  244,  240,  236,  233,  230,  226,  223,     /*  60.5~70  */
      220,  216,  213,  210,  207,  204,  201,  198,  195,  192,       
      190,  187,  184,  182,  179,  177,  174,  172,  169,  167,     /*  70.5~80  */ 
      165,  162,  160,  158,  156,  153,  151,  149,  147,  145      /*  80.5~85  */ //125的10位AD 257.4755595                                                                                        
};
#endif
/* LECU板上NTC的阻值--温度表 */
#ifdef CN0603R103B3435FB
const INT16U PcbResTemp[PCBRESTEMP_SIZE] =
{  
    22824,21487,20238,19071,17980,16959,16004,15109,14270,13485,     /* -40~-31 */   //-40的10位AD 1019.533019
    12748,12056,11407,10797,10225, 9686, 9180, 8704, 8255, 7833,     /* -30~-21 */
     7435, 7061, 6707, 6374, 6059, 5763, 5482, 5217, 4967, 4731,     /* -20~-11 */
     4507, 4295, 4095, 3905, 3725, 3555, 3393, 3240, 3095, 2957,     /* -10~-1  */
     2847, 2703, 2585, 2473, 2366, 2265, 2169, 2077, 1990, 1907,     /*   0~9   */
     1828, 1753, 1681, 1613, 1548, 1486, 1426, 1370, 1316, 1264,     /*  10~19  */ 
     1215, 1168, 1123, 1080, 1039, 1000,  962,  927,  892,  859,     /*  20~29  */
      828,  798,  769,  741,  715,  689,  665,  641,  619,  597,     /*  30~39  */
      577,  557,  538,  520,  502,  485,  469,  453,  438,  424,     /*  40~49  */
      410,  397,  384,  372,  360,  348,  337,  327,  316,  307,     /*  50~59  */
      297,  288,  279,  271,  262,  254,  247,  239,  232,  225,     /*  60~69  */     
      219,  212,  206,  200,  194,  189,  183,  178,  173,  168,     /*  70~79  */
      164,  159,  155,  150,  146,  142,  138,  135,  131,  128,     /*  80~89  */
      124,  121,  118,  115,  112,  109,  106,  103,  100,   98,     /*  90~99  */
       95,   93,   91,   88,   86,   84,   82,   80,   78,   76,     /* 100~109 */
       74,   72,   71,   69,   67,   66,   64,   63,   61,   60,     /* 110~119 */
       58,   57,   56,   54,   53,   52                              /* 120~125 */   //125的10位AD 350.2271351                                                  
};
#endif
/* 温度采样AD通道表 */ 
const INT8U ResTempCh[NUMTEMP] = 
{
    ADCCH0,            
    ADCCH1,          
    ADCCH2,
    ADCCH3,          
    ADCCH4,                      
};
const INT8U PcbResTempCh = ADCCH_PCB; 
/************************************Variable define******************************************/
static INT8U sTempBuf[NUMTEMP][FILTER_NUM];                           /* 温度数据缓冲区 */
static INT8U sPcbTempBuf[FILTER_NUM];                                 /* 板上温度数据缓冲区 */
LECU_INFO LecuInfo;
INT16U Info_TempAd[NUMTEMP];                                          /* 温度采样AD值 */
INT16U Info_PcbTempAd;                                                /* 板上温度采样AD值 */

               
INT8U ResTemp_LookUp(INT16U value, INT16U *p_tab,INT8U size)
{
    INT8U index = 0;
    
    if(value >= *p_tab)
    {
        index = 0;
    }else
    {
        while((value < *(p_tab + index)) && (index < size - 1))    /* 由阻值查阻值-温度表, 表内偏移-40℃ */
        {
            index++;                                           
        }
        if((value - *(p_tab + index)) > (*(p_tab + index - 1) - value))  /* 四舍五入 */
        {
        	  index--;
        }
    } 
    return index;   
}
/*
************************************************************************************************
*  Function:         AdcTemp()
*  Description:      温度采样函数
*  Calls:            无
*  Input:            const INT8U *p_ch,INT8U *p_temp
*  Output:           无 
*  Return:           无 
*  Others:           输入参数:p_ch为AD采样的通道值组的首地址,p_temp为温度存储数组首地址          
************************************************************************************************
*/ 
void ResTemp_Samp(void)
{
    INT8U      i;
    INT16U     result = 0; 
    INT16U     res = 0;                                        
    INT16U     sum = 0;
    static BOOLEAN sAdcTemp_first_rap = TRUE;                  /* first rap采样 */
    static INT8U   sAdcTemp_temp_location = 0;                 /* range of 0~FILTER_NUM-1*/
    
    for(i = 0; i < NUMTEMP; i++)
    {
        result = ADC_Convert(ResTempCh[i]); 
        res = (INT32U)(SERIE_SRES) * result / (1024 - result);   /* 计算阻值, 10位AD值*/          
        sTempBuf[i][sAdcTemp_temp_location] = ResTemp_LookUp(res, &ResTemp[0], RESTEMP_SIZE);
        Info_TempAd[i] = result;
    }   
    {
        result = ADC_Convert(PcbResTempCh); 
        res = (INT32U)(PCB_SERIE_SRES) * result / (1024 - result);    /* 计算阻值, 10位AD值 */    
        sPcbTempBuf[sAdcTemp_temp_location] = ResTemp_LookUp(res, &PcbResTemp[0], PCBRESTEMP_SIZE);
        Info_PcbTempAd = result;
    }
    
    sAdcTemp_temp_location++;
    if(sAdcTemp_temp_location >= FILTER_NUM)                       /* 第一圈完成 */
    {
        sAdcTemp_temp_location = 0;
        sAdcTemp_first_rap = FALSE;
    }
    if(sAdcTemp_first_rap == FALSE)
    {
        for(i = 0; i < NUMTEMP; i++)
        {        
            LecuInfo.Temp[i] = ResTemp_Filter(&sTempBuf[i][0]);           /* 温度数据滤波 */   
        }
        LecuInfo.PcbTemp = ResTemp_Filter(&sPcbTempBuf[0]);          /* 温度数据滤波 */
    }else
    {                                                             /* 第一圈, 直接赋值*/
        for(i = 0; i < NUMTEMP; i++)
        {       
            LecuInfo.Temp[i] = sTempBuf[i][0];         
        }
        LecuInfo.PcbTemp = sPcbTempBuf[0];           
    }                  
}
/*
************************************************************************************************
*  Function:         AdcFilter()
*  Description:      AD滤波函数
*  Calls:            无
*  Input:            INT8U *p_value
*  Output:           无 
*  Return:           INT8U
*  Others:           输入参数:p_value为滤波数组首地址,
*                    取平均值函数返回滤波处理后的数值         
************************************************************************************************
*/ 
INT8U ResTemp_Filter(INT8U *p_value)
{
    INT8U max = *(p_value + 0);                               /* 初始化数组最大值 */
    INT8U min = *(p_value + 0);                               /* 初始化数组最小值 */
    INT8U   i  =             0;             
    INT16U sum =             0;
    INT8U avr =             0;
    
    for(i = 0; i < FILTER_NUM; i++)
    {
        if(*(p_value + i) > max)
        {
            max = *(p_value + i);                              /* 找数组最大值 */
        }else if(*(p_value + i) < min)
        {
            min = *(p_value + i);                              /* 找数组最小值 */
        }
        sum += *(p_value + i);                                 /* 计算数组总和 */
    }
    #if(FILTER_NUM > 2)
        sum = sum - max - min;                                 /* 舍去最大最小值,取平均值 */
        avr = sum / (FILTER_NUM - 2);                                         
    #else
        avr = sum / FILTER_NUM;                                /* 取平均值 */                                      
    #endif
    
    return avr;                                                 
}
/*
************************************************************************************************
*  Function:         Vol_Samp()
*  Description:      电压采样函数
*  Calls:            无
*  Input:            无 
*  Output:           无 
*  Return:           无 
*  Others:                    
************************************************************************************************
*/ 
void Vol_Samp(void)
{
    INT8U i = 0;
    INT16U sum = 0;
    BOOLEAN devstatus = Ltc6803Devstatus();
        
    if(devstatus == FALSE)
    {
        devstatus = Ltc6803CfgInit(0); 
    }
    if(devstatus == FALSE)
    {
        for(i = 0; i < NUMCELL; i++)
        {
            LecuInfo.CellVol[i] = 0;
        }                        
    }else
    {
        devstatus = Ltc6803CellVolDetect(LecuInfo.CellVol);
        if(devstatus == FALSE)
        {
            for(i = 0; i < NUMCELL; i++)
            {
                LecuInfo.CellVol[i] = 0;
            }    
        }
    }
    for(i = 0; i< NUMCELL; i++)
    {
        sum += LecuInfo.CellVol[i];
    }
    LecuInfo.ModuleVol = sum;
}
/*
************************************************************************************************
*  Function:         MaxMinVol_LookUp()
*  Description:      查找电压的最大最小值信息
*  Calls:            无
*  Input:            无 
*  Output:           无 
*  Return:           无 
*  Others:                    
************************************************************************************************
*/ 
void MaxMinVol_LookUp(void)
{
    INT16U max = LecuInfo.CellVol[0];
    INT16U min = LecuInfo.CellVol[0];
    INT8U max_index = 1;
    INT8U min_index = 1;
    INT8U i = 0;
    
    for(i = 0; i < NUMCELL; i++)
    {
        if(max < LecuInfo.CellVol[i])
        {
            max = LecuInfo.CellVol[i];
            max_index = i + 1;    
        }else if(min > LecuInfo.CellVol[i])
        {
            min = LecuInfo.CellVol[i];
            min_index = i + 1;
        }
    }
    LecuInfo.MaxCellVol = max;
    LecuInfo.MinCellVol = min;
    LecuInfo.MaxCellVolIndex = max_index;
    LecuInfo.MinCellVolIndex = min_index;
}
/*
************************************************************************************************
*  Function:         MaxMinVol_LookUp()
*  Description:      查找温度的最大最小值信息
*  Calls:            无
*  Input:            无 
*  Output:           无 
*  Return:           无 
*  Others:                    
************************************************************************************************
*/ 
void MaxMinTemp_LookUp(void)
{
    INT8U max = LecuInfo.Temp[0];
    INT8U min = LecuInfo.Temp[0];
    INT8U max_index = 1;
    INT8U min_index = 1;
    INT8U i = 0;
    
    for(i = 0; i < NUMTEMP; i++)
    {
        if(max < LecuInfo.Temp[i])
        {
            max = LecuInfo.Temp[i];
            max_index = i + 1;    
        }else if(min > LecuInfo.Temp[i])
        {
            min = LecuInfo.Temp[i];
            min_index = i + 1;
        }
    }
    LecuInfo.MaxTemp = max;
    LecuInfo.MinTemp = min;
    LecuInfo.MaxTempIndex = max_index;
    LecuInfo.MinTempIndex = min_index;
}
/*
************************************************************************************************
*  Function:         MaxMinVol_LookUp()
*  Description:      查找单体内阻的最大最小值信息
*  Calls:            无
*  Input:            无 
*  Output:           无 
*  Return:           无 
*  Others:                    
************************************************************************************************
*/ 
void MaxMinInnerRes_LookUp(void)
{
    INT8U max = LecuInfo.InnerRes[0];
    INT8U min = LecuInfo.InnerRes[0];
    INT8U max_index = 1;
    INT8U min_index = 1;
    INT8U i = 0;
    
    for(i = 0; i < NUMCELL; i++)
    {
        if(max < LecuInfo.InnerRes[i])
        {
            max = LecuInfo.InnerRes[i];
            max_index = i + 1;    
        }else if(min > LecuInfo.InnerRes[i])
        {
            min = LecuInfo.InnerRes[i];
            min_index = i + 1;
        }
    }
    LecuInfo.MaxInnerRes = max;
    LecuInfo.MinInnerRes = min;
    LecuInfo.MaxInnerRes = max_index;
    LecuInfo.MinInnerRes = min_index;
}
